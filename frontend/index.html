<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản Lý Bệnh Viện</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Login Form Styles */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
        }
        
        .login-form {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 400px;
        }
        
        .login-form h2 {
            text-align: center;
            margin-bottom: 20px;
            color: #2c3e50;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .btn {
            width: 100%;
            padding: 12px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
        }
        
        .btn:hover {
            background: #2980b9;
        }
        
        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }
        
        .error-message {
            color: #e74c3c;
            text-align: center;
            margin-top: 10px;
            display: none;
        }
        
        /* Dashboard Styles */
        .dashboard {
            display: none;
        }
        
        .header {
            background: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        
        .header h1 {
            color: #2c3e50;
            font-size: 24px;
        }
        
        .auth-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logout-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .logout-btn:hover {
            background: #c0392b;
        }
        
        .login-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .login-btn:hover {
            background: #2980b9;
        }
        
        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .tab-btn {
            flex: 1;
            padding: 15px;
            background: #ecf0f1;
            border: none;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .tab-btn.active {
            background: #3498db;
            color: white;
        }
        
        .tab-btn:hover:not(.active) {
            background: #d5dbdb;
        }
        
        .tab-content {
            display: none;
            background: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-container {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        .form-title {
            margin-bottom: 15px;
            color: #2c3e50;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-col {
            flex: 1;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .btn-primary {
            background: #2ecc71;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .btn-primary:hover {
            background: #27ae60;
        }
        
        .btn-primary:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: #f39c12;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .btn-secondary:hover {
            background: #d35400;
        }
        
        .btn-secondary:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .btn-danger:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: #3498db;
            color: white;
        }
        
        tr:hover {
            background-color: #f5f5f5;
        }
        
        .action-cell {
            display: flex;
            gap: 5px;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            display: none;
        }
        
        .notification.success {
            background: #2ecc71;
        }
        
        .notification.error {
            background: #e74c3c;
        }
        
        .search-container {
            margin-bottom: 20px;
        }
        
        .search-container input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .login-required {
            color: #e74c3c;
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }
    </style>
</head>
<body>
    <!-- Login Form -->
    <div class="login-container" id="loginPage" style="display: none;">
        <div class="login-form">
            <h2>Đăng Nhập Hệ Thống</h2>
            <div class="form-group">
                <label for="username">Tên đăng nhập:</label>
                <input type="text" id="username" placeholder="Nhập tên đăng nhập">
            </div>
            <div class="form-group">
                <label for="password">Mật khẩu:</label>
                <input type="password" id="password" placeholder="Nhập mật khẩu">
            </div>
            <button class="btn" onclick="login()">Đăng Nhập</button>
            <div class="error-message" id="errorMessage"></div>
            <div style="text-align: center; margin-top: 15px;">
                <button class="login-btn" onclick="closeLogin()">Quay Lại</button>
            </div>
        </div>
    </div>

    <!-- Dashboard -->
    <div class="dashboard" id="dashboard">
        <div class="container">
            <div class="header">
                <h1>HỆ THỐNG QUẢN LÝ BỆNH VIỆN</h1>
                <div class="auth-status">
                    <span id="authStatus">Chưa đăng nhập</span>
                    <button class="login-btn" id="loginTriggerBtn" onclick="showLogin()">Đăng Nhập</button>
                    <button class="logout-btn" id="logoutBtn" onclick="logout()" style="display: none;">Đăng Xuất</button>
                </div>
            </div>

            <div class="nav-tabs">
                <button class="tab-btn active" onclick="switchTab('patients')">Bệnh Nhân</button>
                <button class="tab-btn" onclick="switchTab('doctors')">Bác Sĩ</button>
                <button class="tab-btn" onclick="switchTab('departments')">Khoa</button>
                <button class="tab-btn" onclick="switchTab('appointments')">Lịch Hẹn</button>
                <button class="tab-btn" onclick="switchTab('slots')">Ca Khám</button>
            </div>

            <!-- Patients Tab -->
            <div id="patients" class="tab-content active">
                <div class="search-container">
                    <input type="text" id="patientSearch" placeholder="Tìm kiếm bệnh nhân..." onkeyup="searchPatients()">
                </div>
                <div class="form-container">
                    <h3 class="form-title">Quản Lý Bệnh Nhân</h3>
                    <div class="form-row">
                        <div class="form-col">
                            <label>Họ và tên:</label>
                            <input type="text" id="patientFullName" placeholder="Nhập họ tên">
                        </div>
                        <div class="form-col">
                            <label>Số CMND/CCCD:</label>
                            <input type="text" id="patientIdentity" placeholder="Nhập số CMND">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <label>Giới tính:</label>
                            <select id="patientGender">
                                <option value="MALE">Nam</option>
                                <option value="FEMALE">Nữ</option>
                                <option value="OTHER">Khác</option>
                            </select>
                        </div>
                        <div class="form-col">
                            <label>Ngày sinh:</label>
                            <input type="date" id="patientDob">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <label>Số điện thoại:</label>
                            <input type="text" id="patientPhone" placeholder="Nhập số điện thoại">
                        </div>
                        <div class="form-col">
                            <label>Email:</label>
                            <input type="email" id="patientEmail" placeholder="Nhập email">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <label>Số bảo hiểm:</label>
                            <input type="text" id="patientInsurance" placeholder="Nhập số bảo hiểm">
                        </div>
                        <div class="form-col">
                            <label>Địa chỉ:</label>
                            <input type="text" id="patientAddress" placeholder="Nhập địa chỉ">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <label>Người thân khẩn cấp:</label>
                            <input type="text" id="patientEmergencyName" placeholder="Nhập tên người thân">
                        </div>
                        <div class="form-col">
                            <label>SĐT người thân:</label>
                            <input type="text" id="patientEmergencyPhone" placeholder="Nhập SĐT người thân">
                        </div>
                    </div>
                    <div class="login-required" id="patientLoginRequired">(*) Vui lòng đăng nhập để thêm/sửa/xóa</div>
                    <div class="btn-group">
                        <button class="btn-primary" id="savePatientBtn" onclick="savePatient()" disabled>Lưu</button>
                        <button class="btn-secondary" id="resetPatientBtn" onclick="resetPatientForm()" disabled>Hủy</button>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Họ tên</th>
                            <th>CMND</th>
                            <th>Giới tính</th>
                            <th>Ngày sinh</th>
                            <th>SĐT</th>
                            <th>Email</th>
                            <th>Hành động</th>
                        </tr>
                    </thead>
                    <tbody id="patientTableBody">
                    </tbody>
                </table>
            </div>

            <!-- Doctors Tab -->
            <div id="doctors" class="tab-content">
                <div class="search-container">
                    <input type="text" id="doctorSearch" placeholder="Tìm kiếm bác sĩ..." onkeyup="searchDoctors()">
                </div>
                <div class="form-container">
                    <h3 class="form-title">Quản Lý Bác Sĩ</h3>
                    <div class="form-row">
                        <div class="form-col">
                            <label>Họ và tên:</label>
                            <input type="text" id="doctorFullName" placeholder="Nhập họ tên">
                        </div>
                        <div class="form-col">
                            <label>Chuyên khoa:</label>
                            <input type="text" id="doctorSpecialization" placeholder="Nhập chuyên khoa">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <label>Giới tính:</label>
                            <select id="doctorGender">
                                <option value="MALE">Nam</option>
                                <option value="FEMALE">Nữ</option>
                                <option value="OTHER">Khác</option>
                            </select>
                        </div>
                        <div class="form-col">
                            <label>Ngày sinh:</label>
                            <input type="date" id="doctorDob">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <label>Email:</label>
                            <input type="email" id="doctorEmail" placeholder="Nhập email">
                        </div>
                        <div class="form-col">
                            <label>Số điện thoại:</label>
                            <input type="text" id="doctorPhone" placeholder="Nhập số điện thoại">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <label>Khoa:</label>
                            <select id="doctorDepartmentId">
                                <!-- Will be populated dynamically -->
                            </select>
                        </div>
                        <div class="form-col">
                            <label>Giới thiệu:</label>
                            <input type="text" id="doctorBio" placeholder="Nhập giới thiệu">
                        </div>
                    </div>
                    <div class="login-required" id="doctorLoginRequired">(*) Vui lòng đăng nhập để thêm/sửa/xóa</div>
                    <div class="btn-group">
                        <button class="btn-primary" id="saveDoctorBtn" onclick="saveDoctor()" disabled>Lưu</button>
                        <button class="btn-secondary" id="resetDoctorBtn" onclick="resetDoctorForm()" disabled>Hủy</button>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Họ tên</th>
                            <th>Chuyên khoa</th>
                            <th>Giới tính</th>
                            <th>Ngày sinh</th>
                            <th>Email</th>
                            <th>SĐT</th>
                            <th>Khoa</th>
                            <th>Hành động</th>
                        </tr>
                    </thead>
                    <tbody id="doctorTableBody">
                    </tbody>
                </table>
            </div>

            <!-- Departments Tab -->
            <div id="departments" class="tab-content">
                <div class="search-container">
                    <input type="text" id="departmentSearch" placeholder="Tìm kiếm khoa..." onkeyup="searchDepartments()">
                </div>
                <div class="form-container">
                    <h3 class="form-title">Quản Lý Khoa</h3>
                    <div class="form-row">
                        <div class="form-col">
                            <label>Tên khoa:</label>
                            <input type="text" id="departmentName" placeholder="Nhập tên khoa">
                        </div>
                        <div class="form-col">
                            <label>Số điện thoại:</label>
                            <input type="text" id="departmentPhone" placeholder="Nhập số điện thoại">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <label>Bác sĩ trưởng khoa:</label>
                            <select id="departmentHeadDoctorId">
                                <!-- Will be populated dynamically -->
                            </select>
                        </div>
                        <div class="form-col">
                            <label>Mô tả:</label>
                            <input type="text" id="departmentDescription" placeholder="Nhập mô tả">
                        </div>
                    </div>
                    <div class="login-required" id="departmentLoginRequired">(*) Vui lòng đăng nhập để thêm/sửa/xóa</div>
                    <div class="btn-group">
                        <button class="btn-primary" id="saveDepartmentBtn" onclick="saveDepartment()" disabled>Lưu</button>
                        <button class="btn-secondary" id="resetDepartmentBtn" onclick="resetDepartmentForm()" disabled>Hủy</button>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Tên khoa</th>
                            <th>SĐT</th>
                            <th>Bác sĩ trưởng</th>
                            <th>Mô tả</th>
                            <th>Hành động</th>
                        </tr>
                    </thead>
                    <tbody id="departmentTableBody">
                    </tbody>
                </table>
            </div>

            <!-- Appointments Tab -->
            <div id="appointments" class="tab-content">
                <div class="search-container">
                    <input type="text" id="appointmentSearch" placeholder="Tìm kiếm lịch hẹn..." onkeyup="searchAppointments()">
                </div>
                <div class="form-container">
                    <h3 class="form-title">Quản Lý Lịch Hẹn</h3>
                    <div class="form-row">
                        <div class="form-col">
                            <label>Mã lịch hẹn:</label>
                            <input type="text" id="appointmentCode" placeholder="Nhập mã lịch hẹn">
                        </div>
                        <div class="form-col">
                            <label>Ca khám:</label>
                            <select id="appointmentSlotId">
                                <!-- Will be populated dynamically -->
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <label>Bác sĩ:</label>
                            <select id="appointmentDoctorId">
                                <!-- Will be populated dynamically -->
                            </select>
                        </div>
                        <div class="form-col">
                            <label>Bệnh nhân:</label>
                            <select id="appointmentPatientId">
                                <!-- Will be populated dynamically -->
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <label>Khoa:</label>
                            <select id="appointmentDepartmentId">
                                <!-- Will be populated dynamically -->
                            </select>
                        </div>
                        <div class="form-col">
                            <label>Thời gian:</label>
                            <input type="datetime-local" id="appointmentTime">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <label>Trạng thái:</label>
                            <select id="appointmentStatus">
                                <option value="PENDING">Chờ xác nhận</option>
                                <option value="CONFIRMED">Đã xác nhận</option>
                                <option value="CANCELLED">Đã hủy</option>
                                <option value="COMPLETED">Đã hoàn thành</option>
                            </select>
                        </div>
                        <div class="form-col">
                            <label>Ghi chú:</label>
                            <input type="text" id="appointmentNotes" placeholder="Nhập ghi chú">
                        </div>
                    </div>
                    <div class="login-required" id="appointmentLoginRequired">(*) Vui lòng đăng nhập để thêm/sửa/xóa</div>
                    <div class="btn-group">
                        <button class="btn-primary" id="saveAppointmentBtn" onclick="saveAppointment()" disabled>Lưu</button>
                        <button class="btn-secondary" id="resetAppointmentBtn" onclick="resetAppointmentForm()" disabled>Hủy</button>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Mã lịch hẹn</th>
                            <th>Ca khám</th>
                            <th>Bác sĩ</th>
                            <th>Bệnh nhân</th>
                            <th>Khoa</th>
                            <th>Thời gian</th>
                            <th>Trạng thái</th>
                            <th>Hành động</th>
                        </tr>
                    </thead>
                    <tbody id="appointmentTableBody">
                    </tbody>
                </table>
            </div>

            <!-- Slots Tab -->
            <div id="slots" class="tab-content">
                <div class="search-container">
                    <input type="text" id="slotSearch" placeholder="Tìm kiếm ca khám..." onkeyup="searchSlots()">
                </div>
                <div class="form-container">
                    <h3 class="form-title">Quản Lý Ca Khám</h3>
                    <div class="form-row">
                        <div class="form-col">
                            <label>Bác sĩ:</label>
                            <select id="slotDoctorId">
                                <!-- Will be populated dynamically -->
                            </select>
                        </div>
                        <div class="form-col">
                            <label>Thời gian bắt đầu:</label>
                            <input type="datetime-local" id="slotStart">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-col">
                            <label>Thời gian kết thúc:</label>
                            <input type="datetime-local" id="slotEnd">
                        </div>
                        <div class="form-col">
                            <!-- Empty for spacing -->
                        </div>
                    </div>
                    <div class="login-required" id="slotLoginRequired">(*) Vui lòng đăng nhập để thêm/sửa/xóa</div>
                    <div class="btn-group">
                        <button class="btn-primary" id="saveSlotBtn" onclick="saveSlot()" disabled>Lưu</button>
                        <button class="btn-secondary" id="resetSlotBtn" onclick="resetSlotForm()" disabled>Hủy</button>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Bác sĩ</th>
                            <th>Thời gian bắt đầu</th>
                            <th>Thời gian kết thúc</th>
                            <th>Hành động</th>
                        </tr>
                    </thead>
                    <tbody id="slotTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <script>
        // Global variables
        let authToken = '';
        let currentPatientId = null;
        let currentDoctorId = null;
        let currentDepartmentId = null;
        let currentAppointmentId = null;
        let currentSlotId = null;
        
        // API endpoints
        const API_BASE = 'http://localhost:8080/api';
        
        // Switch between tabs
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked tab button
            event.target.classList.add('active');
            
            // Load data for the selected tab
            loadDataForTab(tabName);
        }
        
        // Load data for specific tab
        function loadDataForTab(tabName) {
            switch(tabName) {
                case 'patients':
                    loadPatients();
                    break;
                case 'doctors':
                    loadDoctors();
                    break;
                case 'departments':
                    loadDepartments();
                    break;
                case 'appointments':
                    loadAppointments();
                    break;
                case 'slots':
                    loadSlots();
                    break;
            }
        }
        
        // Show login modal
        function showLogin() {
            document.getElementById('loginPage').style.display = 'flex';
        }
        
        // Close login modal
        function closeLogin() {
            document.getElementById('loginPage').style.display = 'none';
        }
        
        // Login function
        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                showNotification('Vui lòng nhập đầy đủ thông tin đăng nhập!', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    authToken = data.token; // Assuming the token is in 'token' field
                    document.getElementById('loginPage').style.display = 'none';
                    
                    // Update UI to show logged in state
                    updateAuthUI();
                    showNotification('Đăng nhập thành công!', 'success');
                    
                    // Load initial data
                    loadDepartments();
                    loadDoctors();
                    loadPatients();
                    loadSlots();
                    loadAppointments();
                } else {
                    const errorData = await response.text();
                    showNotification(`Đăng nhập thất bại: ${errorData}`, 'error');
                }
            } catch (error) {
                showNotification(`Lỗi kết nối: ${error.message}`, 'error');
            }
        }
        
        // Logout function
        function logout() {
            authToken = '';
            updateAuthUI();
            showNotification('Đăng xuất thành công!', 'success');
        }
        
        // Update UI based on authentication status
        function updateAuthUI() {
            const authStatus = document.getElementById('authStatus');
            const loginTriggerBtn = document.getElementById('loginTriggerBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            
            if (authToken) {
                authStatus.textContent = 'Đã đăng nhập';
                loginTriggerBtn.style.display = 'none';
                logoutBtn.style.display = 'inline-block';
                
                // Enable form buttons
                enableFormButtons(true);
            } else {
                authStatus.textContent = 'Chưa đăng nhập';
                loginTriggerBtn.style.display = 'inline-block';
                logoutBtn.style.display = 'none';
                
                // Disable form buttons
                enableFormButtons(false);
            }
        }
        
        // Enable or disable form buttons based on auth status
        function enableFormButtons(enabled) {
            const buttons = [
                'savePatientBtn', 'resetPatientBtn',
                'saveDoctorBtn', 'resetDoctorBtn',
                'saveDepartmentBtn', 'resetDepartmentBtn',
                'saveAppointmentBtn', 'resetAppointmentBtn',
                'saveSlotBtn', 'resetSlotBtn'
            ];
            
            buttons.forEach(id => {
                const btn = document.getElementById(id);
                if (btn) {
                    btn.disabled = !enabled;
                }
            });
            
            // Show/hide login required messages
            const requiredMsgs = [
                'patientLoginRequired', 'doctorLoginRequired',
                'departmentLoginRequired', 'appointmentLoginRequired',
                'slotLoginRequired'
            ];
            
            requiredMsgs.forEach(id => {
                const msg = document.getElementById(id);
                if (msg) {
                    msg.style.display = enabled ? 'none' : 'block';
                }
            });
        }
        
        // Show notification
        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
        
        // Utility function to add auth header
        function getAuthHeaders() {
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            };
        }
        
        // Check if user is authenticated for operations requiring auth
        function checkAuth(operation) {
            if (!authToken) {
                showNotification(`Vui lòng đăng nhập để ${operation}!`, 'error');
                return false;
            }
            return true;
        }
        
        // PATIENTS MANAGEMENT
        async function loadPatients() {
            try {
                const response = await fetch(`${API_BASE}/patients`);
                
                if (response.ok) {
                    const patients = await response.json();
                    displayPatients(patients);
                } else {
                    showNotification('Lỗi khi tải danh sách bệnh nhân', 'error');
                }
            } catch (error) {
                showNotification(`Lỗi kết nối: ${error.message}`, 'error');
            }
        }
        
        function displayPatients(patients) {
            const tbody = document.getElementById('patientTableBody');
            tbody.innerHTML = '';
            
            patients.forEach(patient => {
                const row = `
                    <tr>
                        <td>${patient.id}</td>
                        <td>${patient.fullName}</td>
                        <td>${patient.identityNumber}</td>
                        <td>${patient.gender}</td>
                        <td>${patient.dateOfBirth}</td>
                        <td>${patient.phone}</td>
                        <td>${patient.email}</td>
                        <td class="action-cell">
                            <button class="btn-secondary" onclick="editPatient(${patient.id})" ${authToken ? '' : 'disabled'}>Sửa</button>
                            <button class="btn-danger" onclick="deletePatient(${patient.id})" ${authToken ? '' : 'disabled'}>Xóa</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }
        
        function searchPatients() {
            const searchTerm = document.getElementById('patientSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#patientTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }
        
        function editPatient(id) {
            if (!checkAuth('sửa bệnh nhân')) return;
            
            // Load patient data and fill form
            fetch(`${API_BASE}/patients/${id}`)
            .then(response => response.json())
            .then(patient => {
                document.getElementById('patientFullName').value = patient.fullName;
                document.getElementById('patientIdentity').value = patient.identityNumber;
                document.getElementById('patientGender').value = patient.gender;
                document.getElementById('patientDob').value = patient.dateOfBirth;
                document.getElementById('patientPhone').value = patient.phone;
                document.getElementById('patientEmail').value = patient.email;
                document.getElementById('patientInsurance').value = patient.insuranceNumber;
                document.getElementById('patientAddress').value = patient.address;
                document.getElementById('patientEmergencyName').value = patient.emergencyContactName;
                document.getElementById('patientEmergencyPhone').value = patient.emergencyContactPhone;
                
                currentPatientId = patient.id;
            })
            .catch(error => {
                showNotification(`Lỗi khi tải thông tin bệnh nhân: ${error.message}`, 'error');
            });
        }
        
        async function savePatient() {
            if (!checkAuth('lưu bệnh nhân')) return;
            
            const patientData = {
                fullName: document.getElementById('patientFullName').value,
                identityNumber: document.getElementById('patientIdentity').value,
                gender: document.getElementById('patientGender').value,
                dateOfBirth: document.getElementById('patientDob').value,
                phone: document.getElementById('patientPhone').value,
                email: document.getElementById('patientEmail').value,
                insuranceNumber: document.getElementById('patientInsurance').value,
                address: document.getElementById('patientAddress').value,
                emergencyContactName: document.getElementById('patientEmergencyName').value,
                emergencyContactPhone: document.getElementById('patientEmergencyPhone').value
            };
            
            try {
                let response;
                if (currentPatientId) {
                    // Update existing patient
                    response = await fetch(`${API_BASE}/patients/${currentPatientId}`, {
                        method: 'PUT',
                        headers: getAuthHeaders(),
                        body: JSON.stringify(patientData)
                    });
                } else {
                    // Create new patient
                    response = await fetch(`${API_BASE}/patients`, {
                        method: 'POST',
                        headers: getAuthHeaders(),
                        body: JSON.stringify(patientData)
                    });
                }
                
                if (response.ok) {
                    const result = await response.json();
                    showNotification(currentPatientId ? 'Cập nhật bệnh nhân thành công!' : 'Thêm bệnh nhân thành công!', 'success');
                    loadPatients();
                    resetPatientForm();
                } else {
                    const errorData = await response.text();
                    showNotification(`Lỗi khi lưu bệnh nhân: ${errorData}`, 'error');
                }
            } catch (error) {
                showNotification(`Lỗi kết nối: ${error.message}`, 'error');
            }
        }
        
        function deletePatient(id) {
            if (!checkAuth('xóa bệnh nhân')) return;
            
            if (confirm('Bạn có chắc chắn muốn xóa bệnh nhân này?')) {
                fetch(`${API_BASE}/patients/${id}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                })
                .then(response => {
                    if (response.ok) {
                        showNotification('Xóa bệnh nhân thành công!', 'success');
                        loadPatients();
                    } else {
                        showNotification('Lỗi khi xóa bệnh nhân', 'error');
                    }
                })
                .catch(error => {
                    showNotification(`Lỗi kết nối: ${error.message}`, 'error');
                });
            }
        }
        
        function resetPatientForm() {
            if (!checkAuth('hủy thao tác')) return;
            
            document.getElementById('patientFullName').value = '';
            document.getElementById('patientIdentity').value = '';
            document.getElementById('patientGender').value = 'MALE';
            document.getElementById('patientDob').value = '';
            document.getElementById('patientPhone').value = '';
            document.getElementById('patientEmail').value = '';
            document.getElementById('patientInsurance').value = '';
            document.getElementById('patientAddress').value = '';
            document.getElementById('patientEmergencyName').value = '';
            document.getElementById('patientEmergencyPhone').value = '';
            currentPatientId = null;
        }
        
        // DOCTORS MANAGEMENT
        async function loadDoctors() {
            try {
                const response = await fetch(`${API_BASE}/doctors`);
                
                if (response.ok) {
                    const doctors = await response.json();
                    displayDoctors(doctors);
                } else {
                    showNotification('Lỗi khi tải danh sách bác sĩ', 'error');
                }
            } catch (error) {
                showNotification(`Lỗi kết nối: ${error.message}`, 'error');
            }
        }
        
        function displayDoctors(doctors) {
            const tbody = document.getElementById('doctorTableBody');
            tbody.innerHTML = '';
            
            doctors.forEach(doctor => {
                const department = departments.find(d => d.id === doctor.departmentId);
                const departmentName = department ? department.name : 'Không xác định';
                
                const row = `
                    <tr>
                        <td>${doctor.id}</td>
                        <td>${doctor.fullName}</td>
                        <td>${doctor.specialization}</td>
                        <td>${doctor.gender}</td>
                        <td>${doctor.dateOfBirth}</td>
                        <td>${doctor.email}</td>
                        <td>${doctor.phone}</td>
                        <td>${departmentName}</td>
                        <td class="action-cell">
                            <button class="btn-secondary" onclick="editDoctor(${doctor.id})" ${authToken ? '' : 'disabled'}>Sửa</button>
                            <button class="btn-danger" onclick="deleteDoctor(${doctor.id})" ${authToken ? '' : 'disabled'}>Xóa</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }
        
        function searchDoctors() {
            const searchTerm = document.getElementById('doctorSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#doctorTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }
        
        function editDoctor(id) {
            if (!checkAuth('sửa bác sĩ')) return;
            
            fetch(`${API_BASE}/doctors/${id}`)
            .then(response => response.json())
            .then(doctor => {
                document.getElementById('doctorFullName').value = doctor.fullName;
                document.getElementById('doctorSpecialization').value = doctor.specialization;
                document.getElementById('doctorGender').value = doctor.gender;
                document.getElementById('doctorDob').value = doctor.dateOfBirth;
                document.getElementById('doctorEmail').value = doctor.email;
                document.getElementById('doctorPhone').value = doctor.phone;
                document.getElementById('doctorBio').value = doctor.bio;
                document.getElementById('doctorDepartmentId').value = doctor.departmentId;
                
                currentDoctorId = doctor.id;
            })
            .catch(error => {
                showNotification(`Lỗi khi tải thông tin bác sĩ: ${error.message}`, 'error');
            });
        }
        
        async function saveDoctor() {
            if (!checkAuth('lưu bác sĩ')) return;
            
            const doctorData = {
                fullName: document.getElementById('doctorFullName').value,
                specialization: document.getElementById('doctorSpecialization').value,
                gender: document.getElementById('doctorGender').value,
                dateOfBirth: document.getElementById('doctorDob').value,
                email: document.getElementById('doctorEmail').value,
                phone: document.getElementById('doctorPhone').value,
                bio: document.getElementById('doctorBio').value,
                departmentId: parseInt(document.getElementById('doctorDepartmentId').value)
            };
            
            try {
                let response;
                if (currentDoctorId) {
                    response = await fetch(`${API_BASE}/doctors/${currentDoctorId}`, {
                        method: 'PUT',
                        headers: getAuthHeaders(),
                        body: JSON.stringify(doctorData)
                    });
                } else {
                    response = await fetch(`${API_BASE}/doctors`, {
                        method: 'POST',
                        headers: getAuthHeaders(),
                        body: JSON.stringify(doctorData)
                    });
                }
                
                if (response.ok) {
                    const result = await response.json();
                    showNotification(currentDoctorId ? 'Cập nhật bác sĩ thành công!' : 'Thêm bác sĩ thành công!', 'success');
                    loadDoctors();
                    resetDoctorForm();
                } else {
                    const errorData = await response.text();
                    showNotification(`Lỗi khi lưu bác sĩ: ${errorData}`, 'error');
                }
            } catch (error) {
                showNotification(`Lỗi kết nối: ${error.message}`, 'error');
            }
        }
        
        function deleteDoctor(id) {
            if (!checkAuth('xóa bác sĩ')) return;
            
            if (confirm('Bạn có chắc chắn muốn xóa bác sĩ này?')) {
                fetch(`${API_BASE}/doctors/${id}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                })
                .then(response => {
                    if (response.ok) {
                        showNotification('Xóa bác sĩ thành công!', 'success');
                        loadDoctors();
                        loadDepartments(); // Reload departments as they might reference this doctor
                    } else {
                        showNotification('Lỗi khi xóa bác sĩ', 'error');
                    }
                })
                .catch(error => {
                    showNotification(`Lỗi kết nối: ${error.message}`, 'error');
                });
            }
        }
        
        function resetDoctorForm() {
            if (!checkAuth('hủy thao tác')) return;
            
            document.getElementById('doctorFullName').value = '';
            document.getElementById('doctorSpecialization').value = '';
            document.getElementById('doctorGender').value = 'MALE';
            document.getElementById('doctorDob').value = '';
            document.getElementById('doctorEmail').value = '';
            document.getElementById('doctorPhone').value = '';
            document.getElementById('doctorBio').value = '';
            document.getElementById('doctorDepartmentId').value = '';
            currentDoctorId = null;
        }
        
        // DEPARTMENTS MANAGEMENT
        let departments = []; // Cache for departments
        
        async function loadDepartments() {
            try {
                const response = await fetch(`${API_BASE}/departments`);
                
                if (response.ok) {
                    departments = await response.json();
                    displayDepartments(departments);
                    populateDepartmentSelects();
                    populateDoctorSelects();
                } else {
                    showNotification('Lỗi khi tải danh sách khoa', 'error');
                }
            } catch (error) {
                showNotification(`Lỗi kết nối: ${error.message}`, 'error');
            }
        }
        
        function displayDepartments(departments) {
            const tbody = document.getElementById('departmentTableBody');
            tbody.innerHTML = '';
            
            departments.forEach(dept => {
                const headDoctor = doctorsCache.find(d => d.id === dept.headDoctorId);
                const headDoctorName = headDoctor ? headDoctor.fullName : 'Không có';
                
                const row = `
                    <tr>
                        <td>${dept.id}</td>
                        <td>${dept.name}</td>
                        <td>${dept.phone}</td>
                        <td>${headDoctorName}</td>
                        <td>${dept.description}</td>
                        <td class="action-cell">
                            <button class="btn-secondary" onclick="editDepartment(${dept.id})" ${authToken ? '' : 'disabled'}>Sửa</button>
                            <button class="btn-danger" onclick="deleteDepartment(${dept.id})" ${authToken ? '' : 'disabled'}>Xóa</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }
        
        function populateDepartmentSelects() {
            const selects = [
                document.getElementById('doctorDepartmentId'),
                document.getElementById('appointmentDepartmentId'),
                document.getElementById('departmentHeadDoctorId')
            ];
            
            selects.forEach(select => {
                if (!select) return; // Skip if element doesn't exist yet
                select.innerHTML = '<option value="">Chọn khoa</option>';
                departments.forEach(dept => {
                    const option = document.createElement('option');
                    option.value = dept.id;
                    option.textContent = dept.name;
                    select.appendChild(option);
                });
            });
        }
        
        function searchDepartments() {
            const searchTerm = document.getElementById('departmentSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#departmentTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }
        
        function editDepartment(id) {
            if (!checkAuth('sửa khoa')) return;
            
            const dept = departments.find(d => d.id === id);
            if (dept) {
                document.getElementById('departmentName').value = dept.name;
                document.getElementById('departmentPhone').value = dept.phone;
                document.getElementById('departmentHeadDoctorId').value = dept.headDoctorId;
                document.getElementById('departmentDescription').value = dept.description;
                
                currentDepartmentId = dept.id;
            }
        }
        
        async function saveDepartment() {
            if (!checkAuth('lưu khoa')) return;
            
            const deptData = {
                name: document.getElementById('departmentName').value,
                phone: document.getElementById('departmentPhone').value,
                headDoctorId: parseInt(document.getElementById('departmentHeadDoctorId').value) || null,
                description: document.getElementById('departmentDescription').value
            };
            
            try {
                let response;
                if (currentDepartmentId) {
                    response = await fetch(`${API_BASE}/departments/${currentDepartmentId}`, {
                        method: 'PUT',
                        headers: getAuthHeaders(),
                        body: JSON.stringify(deptData)
                    });
                } else {
                    response = await fetch(`${API_BASE}/departments`, {
                        method: 'POST',
                        headers: getAuthHeaders(),
                        body: JSON.stringify(deptData)
                    });
                }
                
                if (response.ok) {
                    const result = await response.json();
                    showNotification(currentDepartmentId ? 'Cập nhật khoa thành công!' : 'Thêm khoa thành công!', 'success');
                    loadDepartments();
                    resetDepartmentForm();
                } else {
                    const errorData = await response.text();
                    showNotification(`Lỗi khi lưu khoa: ${errorData}`, 'error');
                }
            } catch (error) {
                showNotification(`Lỗi kết nối: ${error.message}`, 'error');
            }
        }
        
        function deleteDepartment(id) {
            if (!checkAuth('xóa khoa')) return;
            
            if (confirm('Bạn có chắc chắn muốn xóa khoa này?')) {
                fetch(`${API_BASE}/departments/${id}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                })
                .then(response => {
                    if (response.ok) {
                        showNotification('Xóa khoa thành công!', 'success');
                        loadDepartments();
                    } else {
                        showNotification('Lỗi khi xóa khoa', 'error');
                    }
                })
                .catch(error => {
                    showNotification(`Lỗi kết nối: ${error.message}`, 'error');
                });
            }
        }
        
        function resetDepartmentForm() {
            if (!checkAuth('hủy thao tác')) return;
            
            document.getElementById('departmentName').value = '';
            document.getElementById('departmentPhone').value = '';
            document.getElementById('departmentHeadDoctorId').value = '';
            document.getElementById('departmentDescription').value = '';
            currentDepartmentId = null;
        }
        
        // APPOINTMENTS MANAGEMENT
        let appointments = [];
        let doctorsCache = [];
        let patientsCache = [];
        let slotsCache = [];
        
        async function loadAppointments() {
            try {
                // Load related data first
                const [appointmentsRes, doctorsRes, patientsRes, slotsRes] = await Promise.all([
                    fetch(`${API_BASE}/appointments`),
                    fetch(`${API_BASE}/doctors`),
                    fetch(`${API_BASE}/patients`),
                    fetch(`${API_BASE}/slots`)
                ]);
                
                if (appointmentsRes.ok && doctorsRes.ok && patientsRes.ok && slotsRes.ok) {
                    appointments = await appointmentsRes.json();
                    doctorsCache = await doctorsRes.json();
                    patientsCache = await patientsRes.json();
                    slotsCache = await slotsRes.json();
                    
                    displayAppointments(appointments);
                    populateAppointmentSelects();
                } else {
                    showNotification('Lỗi khi tải dữ liệu lịch hẹn', 'error');
                }
            } catch (error) {
                showNotification(`Lỗi kết nối: ${error.message}`, 'error');
            }
        }
        
        function displayAppointments(appointments) {
            const tbody = document.getElementById('appointmentTableBody');
            tbody.innerHTML = '';
            
            appointments.forEach(app => {
                const doctor = doctorsCache.find(d => d.id === app.doctorId);
                const patient = patientsCache.find(p => p.id === app.patientId);
                const slot = slotsCache.find(s => s.id === app.slotId);
                const department = departments.find(d => d.id === app.departmentId);
                
                const doctorName = doctor ? doctor.fullName : 'Không xác định';
                const patientName = patient ? patient.fullName : 'Không xác định';
                const slotTime = slot ? `${new Date(slot.startUtc).toLocaleString()} - ${new Date(slot.endUtc).toLocaleString()}` : 'Không xác định';
                const deptName = department ? department.name : 'Không xác định';
                
                const row = `
                    <tr>
                        <td>${app.id}</td>
                        <td>${app.appointmentCode}</td>
                        <td>${slotTime}</td>
                        <td>${doctorName}</td>
                        <td>${patientName}</td>
                        <td>${deptName}</td>
                        <td>${new Date(app.time).toLocaleString()}</td>
                        <td>${app.status}</td>
                        <td class="action-cell">
                            <button class="btn-secondary" onclick="editAppointment(${app.id})" ${authToken ? '' : 'disabled'}>Sửa</button>
                            <button class="btn-danger" onclick="deleteAppointment(${app.id})" ${authToken ? '' : 'disabled'}>Xóa</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }
        
        function populateAppointmentSelects() {
            // Populate doctors
            const doctorSelect = document.getElementById('appointmentDoctorId');
            if (doctorSelect) {
                doctorSelect.innerHTML = '<option value="">Chọn bác sĩ</option>';
                doctorsCache.forEach(doctor => {
                    const option = document.createElement('option');
                    option.value = doctor.id;
                    option.textContent = doctor.fullName;
                    doctorSelect.appendChild(option);
                });
            }
            
            // Populate patients
            const patientSelect = document.getElementById('appointmentPatientId');
            if (patientSelect) {
                patientSelect.innerHTML = '<option value="">Chọn bệnh nhân</option>';
                patientsCache.forEach(patient => {
                    const option = document.createElement('option');
                    option.value = patient.id;
                    option.textContent = patient.fullName;
                    patientSelect.appendChild(option);
                });
            }
            
            // Populate slots
            const slotSelect = document.getElementById('appointmentSlotId');
            if (slotSelect) {
                slotSelect.innerHTML = '<option value="">Chọn ca khám</option>';
                slotsCache.forEach(slot => {
                    const option = document.createElement('option');
                    option.value = slot.id;
                    option.textContent = `${new Date(slot.startUtc).toLocaleString()} - ${new Date(slot.endUtc).toLocaleString()}`;
                    slotSelect.appendChild(option);
                });
            }
        }
        
        function populateDoctorSelects() {
            const deptSelect = document.getElementById('departmentHeadDoctorId');
            if (deptSelect) {
                deptSelect.innerHTML = '<option value="">Chọn bác sĩ trưởng khoa</option>';
                doctorsCache.forEach(doctor => {
                    const option = document.createElement('option');
                    option.value = doctor.id;
                    option.textContent = doctor.fullName;
                    deptSelect.appendChild(option);
                });
            }
        }
        
        function searchAppointments() {
            const searchTerm = document.getElementById('appointmentSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#appointmentTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }
        
        function editAppointment(id) {
            if (!checkAuth('sửa lịch hẹn')) return;
            
            const app = appointments.find(a => a.id === id);
            if (app) {
                document.getElementById('appointmentCode').value = app.appointmentCode;
                document.getElementById('appointmentSlotId').value = app.slotId;
                document.getElementById('appointmentDoctorId').value = app.doctorId;
                document.getElementById('appointmentPatientId').value = app.patientId;
                document.getElementById('appointmentDepartmentId').value = app.departmentId;
                document.getElementById('appointmentTime').value = app.time ? app.time.slice(0, 16) : '';
                document.getElementById('appointmentStatus').value = app.status;
                document.getElementById('appointmentNotes').value = app.notes;
                
                currentAppointmentId = app.id;
            }
        }
        
        async function saveAppointment() {
            if (!checkAuth('lưu lịch hẹn')) return;
            
            const appointmentData = {
                appointmentCode: document.getElementById('appointmentCode').value,
                slotId: parseInt(document.getElementById('appointmentSlotId').value),
                doctorId: parseInt(document.getElementById('appointmentDoctorId').value),
                patientId: parseInt(document.getElementById('appointmentPatientId').value),
                departmentId: parseInt(document.getElementById('appointmentDepartmentId').value),
                time: document.getElementById('appointmentTime').value,
                status: document.getElementById('appointmentStatus').value,
                notes: document.getElementById('appointmentNotes').value
            };
            
            try {
                let response;
                if (currentAppointmentId) {
                    response = await fetch(`${API_BASE}/appointments/${currentAppointmentId}`, {
                        method: 'PUT',
                        headers: getAuthHeaders(),
                        body: JSON.stringify(appointmentData)
                    });
                } else {
                    response = await fetch(`${API_BASE}/appointments`, {
                        method: 'POST',
                        headers: getAuthHeaders(),
                        body: JSON.stringify(appointmentData)
                    });
                }
                
                if (response.ok) {
                    const result = await response.json();
                    showNotification(currentAppointmentId ? 'Cập nhật lịch hẹn thành công!' : 'Thêm lịch hẹn thành công!', 'success');
                    loadAppointments();
                    resetAppointmentForm();
                } else {
                    const errorData = await response.text();
                    showNotification(`Lỗi khi lưu lịch hẹn: ${errorData}`, 'error');
                }
            } catch (error) {
                showNotification(`Lỗi kết nối: ${error.message}`, 'error');
            }
        }
        
        function deleteAppointment(id) {
            if (!checkAuth('xóa lịch hẹn')) return;
            
            if (confirm('Bạn có chắc chắn muốn xóa lịch hẹn này?')) {
                fetch(`${API_BASE}/appointments/${id}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                })
                .then(response => {
                    if (response.ok) {
                        showNotification('Xóa lịch hẹn thành công!', 'success');
                        loadAppointments();
                    } else {
                        showNotification('Lỗi khi xóa lịch hẹn', 'error');
                    }
                })
                .catch(error => {
                    showNotification(`Lỗi kết nối: ${error.message}`, 'error');
                });
            }
        }
        
        function resetAppointmentForm() {
            if (!checkAuth('hủy thao tác')) return;
            
            document.getElementById('appointmentCode').value = '';
            document.getElementById('appointmentSlotId').value = '';
            document.getElementById('appointmentDoctorId').value = '';
            document.getElementById('appointmentPatientId').value = '';
            document.getElementById('appointmentDepartmentId').value = '';
            document.getElementById('appointmentTime').value = '';
            document.getElementById('appointmentStatus').value = 'PENDING';
            document.getElementById('appointmentNotes').value = '';
            currentAppointmentId = null;
        }
        
        // SLOTS MANAGEMENT
        async function loadSlots() {
            try {
                const response = await fetch(`${API_BASE}/slots`);
                
                if (response.ok) {
                    slotsCache = await response.json();
                    displaySlots(slotsCache);
                    populateSlotSelects();
                } else {
                    showNotification('Lỗi khi tải danh sách ca khám', 'error');
                }
            } catch (error) {
                showNotification(`Lỗi kết nối: ${error.message}`, 'error');
            }
        }
        
        function displaySlots(slots) {
            const tbody = document.getElementById('slotTableBody');
            tbody.innerHTML = '';
            
            slots.forEach(slot => {
                const doctor = doctorsCache.find(d => d.id === slot.doctorId);
                const doctorName = doctor ? doctor.fullName : 'Không xác định';
                
                const row = `
                    <tr>
                        <td>${slot.id}</td>
                        <td>${doctorName}</td>
                        <td>${new Date(slot.startUtc).toLocaleString()}</td>
                        <td>${new Date(slot.endUtc).toLocaleString()}</td>
                        <td class="action-cell">
                            <button class="btn-secondary" onclick="editSlot(${slot.id})" ${authToken ? '' : 'disabled'}>Sửa</button>
                            <button class="btn-danger" onclick="deleteSlot(${slot.id})" ${authToken ? '' : 'disabled'}>Xóa</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }
        
        function populateSlotSelects() {
            const slotSelect = document.getElementById('appointmentSlotId');
            if (slotSelect) {
                slotSelect.innerHTML = '<option value="">Chọn ca khám</option>';
                slotsCache.forEach(slot => {
                    const option = document.createElement('option');
                    option.value = slot.id;
                    option.textContent = `${new Date(slot.startUtc).toLocaleString()} - ${new Date(slot.endUtc).toLocaleString()}`;
                    slotSelect.appendChild(option);
                });
            }
            
            // Also populate slot doctor select
            const doctorSelect = document.getElementById('slotDoctorId');
            if (doctorSelect) {
                doctorSelect.innerHTML = '<option value="">Chọn bác sĩ</option>';
                doctorsCache.forEach(doctor => {
                    const option = document.createElement('option');
                    option.value = doctor.id;
                    option.textContent = doctor.fullName;
                    doctorSelect.appendChild(option);
                });
            }
        }
        
        function searchSlots() {
            const searchTerm = document.getElementById('slotSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#slotTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }
        
        function editSlot(id) {
            if (!checkAuth('sửa ca khám')) return;
            
            const slot = slotsCache.find(s => s.id === id);
            if (slot) {
                document.getElementById('slotDoctorId').value = slot.doctorId;
                document.getElementById('slotStart').value = slot.startUtc.slice(0, 16);
                document.getElementById('slotEnd').value = slot.endUtc.slice(0, 16);
                
                currentSlotId = slot.id;
            }
        }
        
        async function saveSlot() {
            if (!checkAuth('lưu ca khám')) return;
            
            const slotData = {
                doctorId: parseInt(document.getElementById('slotDoctorId').value),
                startUtc: document.getElementById('slotStart').value,
                endUtc: document.getElementById('slotEnd').value
            };
            
            try {
                let response;
                if (currentSlotId) {
                    response = await fetch(`${API_BASE}/slots/${currentSlotId}`, {
                        method: 'PUT',
                        headers: getAuthHeaders(),
                        body: JSON.stringify(slotData)
                    });
                } else {
                    response = await fetch(`${API_BASE}/slots`, {
                        method: 'POST',
                        headers: getAuthHeaders(),
                        body: JSON.stringify(slotData)
                    });
                }
                
                if (response.ok) {
                    const result = await response.json();
                    showNotification(currentSlotId ? 'Cập nhật ca khám thành công!' : 'Thêm ca khám thành công!', 'success');
                    loadSlots();
                    resetSlotForm();
                } else {
                    const errorData = await response.text();
                    showNotification(`Lỗi khi lưu ca khám: ${errorData}`, 'error');
                }
            } catch (error) {
                showNotification(`Lỗi kết nối: ${error.message}`, 'error');
            }
        }
        
        function deleteSlot(id) {
            if (!checkAuth('xóa ca khám')) return;
            
            if (confirm('Bạn có chắc chắn muốn xóa ca khám này?')) {
                fetch(`${API_BASE}/slots/${id}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                })
                .then(response => {
                    if (response.ok) {
                        showNotification('Xóa ca khám thành công!', 'success');
                        loadSlots();
                    } else {
                        showNotification('Lỗi khi xóa ca khám', 'error');
                    }
                })
                .catch(error => {
                    showNotification(`Lỗi kết nối: ${error.message}`, 'error');
                });
            }
        }
        
        function resetSlotForm() {
            if (!checkAuth('hủy thao tác')) return;
            
            document.getElementById('slotDoctorId').value = '';
            document.getElementById('slotStart').value = '';
            document.getElementById('slotEnd').value = '';
            currentSlotId = null;
        }
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Show dashboard by default (without login)
            document.getElementById('dashboard').style.display = 'block';
            updateAuthUI(); // Initialize auth UI state
            
            // Load departments first as they are referenced by other entities
            loadDepartments();
        });
    </script>
</body>
</html>

